<!DOCTYPE html>
<html>
  <head>
    <script language="javascript" src="jslib/jquery-3.3.1.js"></script>
    <script language="javascript" src="jslib/jquery.cookie.js"></script>
    <script language="javascript" src="jslib/Tone.js"></script>
    <script language="javascript" src="jslib/Keyboard.js"></script>
    <script language="javascript" src="jslib/DrumKit.js"></script>
    <script language="javascript" src="jslib/MIDITools.js"></script>
    <script language="javascript" src="Drumsheet.jsexe/rts.js"></script>
    <script language="javascript" src="Drumsheet.jsexe/lib.js"></script>
    <script language="javascript" src="Drumsheet.jsexe/out.js"></script>

    <script language="javascript">
     function show_error(error) {
       $('#container').addClass('error');
       $('#status').text(error);
     }
     function hide_error() {
       $('#container').removeClass('error');
       $('#status').text('');
     }

     function install_handlers(play, stop, reload) {
       var playing = false;
       var changed = true;
      
       var toggle_play = function() {
         if (playing) {
           stop();
           playing = false;
         }
         else {
           play();
           playing = true;
         }
       };
       var ensure_playing = function() {
         if (!playing) {
           play();
           playing = true;
         }
       };

       $('#drumsheet').keydown(e => {
         if (e.which == 13 && e.shiftKey) {
           if (changed) {
             reload(
               () => { ensure_playing(); changed = false; hide_error(); }, 
               e  => { changed = false; show_error(e) });
           }
           else {
             toggle_play();
           }
           return false;
         }
         else {
           changed = true;
         }
       });
     }
    </script>

    <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #container {
      min-height: 100%;
      height: 100%;
    }
    #drumsheet {
      font-family: monospace;
      font-size: 12pt;
      font-weight: bold;
      color: #040;
      background: #ffddd4;
      width: 100%;
      min-height: 100%;
    }
    .error #drumsheet {
      min-height: calc(100% - 6*12pt);
    }
    #status {
      font-family: monospace;
      background: #faa;
      padding: 5px;
      min-height: 40px;
      display: none;
      font-size: 12pt;
    }
    .error #status {
      display: block;
    }
    </style>
  </head>
  <body>
   <div id="container">
     <textarea id="drumsheet" rows="35" cols="80">
tempo 4*90

init = A:bar
[kick] bar = +... ...- +... ....
[snare] bar = .... +... .... +...

// Controls:
//   Shift-Enter to play or reload while playing
//   Shift-Enter-Enter to stop
// Syntax:
//   .           silence
//   - + * #     quiet, medium, loud, extra loud hit
//   //          "comment" - disabled line

// ** Uncomment (remove // from the beginning) each of these example lines and reload
//    to see their effect.
// [hat] bar = ..-- ..-. ..-. ..-.       // Basic hi hat
// [hat] bar = [3/4](.-- .-. .-- ..-)    // Tuplets
// [tom ride] bar = *... *... *... *...  // Multiple instruments
// bar = *... *... *... *...             // All instruments

// ** When multiple rules apply, it chooses between them randomly on each repetition.

// ** You can make "phrases" with structured repetition:
//    (Disable the init line at the top otherwise some instruments will only play 1 bar)
//
// init = A:bar A:bar A:bar B:bar   // 3 identical bars and then a different one

// ** Or you can define and mix different symbols. 
// fill = A:bar
// fill = ++.* .*.+ .+.- ++--
// init = A:bar B:bar A:bar C:fill

// ** Build up complex beats from simple pieces
// bar = A:halfbar B:halfbar
// [kick] halfbar = +... ....
// [kick] halfbar = +... ...+
// [kick] halfbar = .-+. ....
// [snare] halfbar = .... +...
// [snare] halfbar = ...- .-..
// [ride] halfbar = +... +...
// [ride] halfbar = ..+. ..+.

// ** You can define recursive rules, too (woah).
// bar = [2/1](A:bar A:bar)

</textarea>
     <pre id="status" class="hidden"></pre>
   </div>
   <button id="run">Run</button>
  </body>
  <script language="javascript" src="Drumsheet.jsexe/runmain.js" defer></script>
</html>
