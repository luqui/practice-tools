<html>
  <head>
    <style>
    #skillMeter {
      width: 500px;
      background-color: lightgray;
    }
    #skillReading {
      width: 1%;
      height: 30px;
      background-color: lightgreen;
    }
    </style>

    <script src="jquery-3.3.1.js"></script>
    <script src="vexflow-debug.js"></script>
    <script>
      var outdevice = null;

      var sendMIDI = function(data) {
        if (outdevice) {
          outdevice.send(data);
        }
      };

      var setDeviceList = function(sel, devs, onchange) {
        $('#devices').empty();
        $(sel).append($('<option>').attr('value', null).text("None"));
        for (var i = 0; i < devs.length; i++) {
          $(sel).append(
            $('<option>').attr('value', i).text(devs[i].name));
        }
        $(sel).change(e => {
          onchange(devs[$(sel).val()]);
        });
      };

      var Metronome = function(bpm, callback) {
        var interval = 1000*60.0/bpm;

        var stop = false;

        var start = Date.now();
        var beatno = 0;
        var step = () => {
          callback(beatno);
          beatno += 1;
          var next = start + beatno * interval;
          if (!stop) { setTimeout(step, next - Date.now()); }
        };
        step();

        return {
          stop: () => { stop = true; },
          measure: () => (Date.now() - start) / interval,
          toMS: beats => beats*interval,
        };
      };

      var metronome = null;

      var initializeMetronome = function() {
        metronome = null;
        $('#metronomeStart').text('Start');
        $('#metronomeStart').off('click').click(e => {
          var note = parseInt($('#metronomeNote').val());
          metronome = Metronome(parseInt($('#metronomeTempo').val()), beatno => {
            sendMIDI([0x91, note, 0x50]);
            setTimeout(() => sendMIDI([0x91, note, 0], 30));
          });
          $('#metronomeStart').text('Stop');
          $('#metronomeStart').off('click').on('click', e => {
            metronome.stop();
            initializeMetronome();
          });
        });
      };

      var SkillMeter = function(barElem, notches, penalty) {
        var score = 0;
        var update = () => $(barElem).css('width', Math.round(100.0*score/notches) + '%');
        update();
        return {
          hit: () => {
            score++;
            console.log("Hit:", score);
            score = Math.min(score, notches);
            update();
          },
          miss: () => {
            score *= penalty;
            console.log("Miss:", score);
            update();
          },
        };
      };

      var skillmeter = null;

      $(() => {
        navigator.requestMIDIAccess().then(access => {
          setDeviceList($('#indevices'), Array.from(access.inputs.values()), inp => {
            inp.onmidimessage = msg => {
              if (metronome && msg.data[0] == 0x90 && msg.data[2] != 0) {
                var beats = metronome.measure();
                var roundBeats = Math.round(4*beats)/4.0;

                if (Math.abs(metronome.toMS(roundBeats - beats)) < 35) {
                  sendMIDI(msg.data);
                  if (skillmeter) { skillmeter.hit(); }
                }
                else {
                  if (skillmeter) { skillmeter.miss(); }
                }
              }
              else {
                sendMIDI(msg.data);
              }
            };
          });
          setDeviceList($('#outdevices'), Array.from(access.outputs.values()), outp => {
            outdevice = outp;
          });

          // Debug
          $('#indevices').val(1).change();
          $('#outdevices').val(0).change();

          initializeMetronome();

          skillmeter = SkillMeter($('#skillReading'), 200, 0.75);
        });

      });
    </script>
  </head>
  <body>
    <b>In:</b><select id="indevices"></select>
    <b>Out:</b><select id="outdevices"></select>
    <br/>
    <b>Metronome:</b> Note <input id="metronomeNote" value="42">, Tempo <input id="metronomeTempo" type="text" value="100" /><button id="metronomeStart"></button>
    <pre id="log"></pre>

    <div id="skillMeter">
      <div id="skillReading"></div>
    </div>
      
  </body>
</html>
