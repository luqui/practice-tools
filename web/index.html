<html>
  <head>
    <script src="jquery-3.3.1.js"></script>
    <script src="vexflow-debug.js"></script>
    <script>
      var outdevice = null;

      var setDeviceList = function(sel, devs, onchange) {
        $('#devices').empty();
        $(sel).append($('<option>').attr('value', null).text("None"));
        for (var i = 0; i < devs.length; i++) {
          $(sel).append(
            $('<option>').attr('value', i).text(devs[i].name));
        }
        $(sel).change(e => {
          onchange(devs[$(sel).val()]);
        });
      };

      var Metronome = function(bpm, callback) {
        var interval = 1000*60.0/bpm;

        var stop = false;

        var start = Date.now();
        var beatno = 0;
        var step = () => {
          callback(beatno);
          beatno += 1;
          var next = start + beatno * interval;
          if (!stop) { setTimeout(step, next - Date.now()); }
        };
        step();

        return {
          stop: () => { stop = true; },
          measure: () => (Date.now() - start) / interval,
          toMS: beats => beats*interval,
        };
      };

      var metronome = null;

      var initializeMetronome = function() {
        metronome = null;
        $('#metronomeStart').text('Start');
        $('#metronomeStart').click(e => {
          var note = parseInt($('#metronomeNote').val());
          metronome = Metronome(parseInt($('#metronomeTempo').val()), beatno => outdevice.send([0x91, note, 0x7f]));
          $('#metronomeStart').text('Stop');
          $('#metronomeStart').off('click').on('click', e => {
            metronome.stop();
            initializeMetronome();
          });
        });
      };

      $(() => {
        navigator.requestMIDIAccess().then(access => {
          setDeviceList($('#indevices'), Array.from(access.inputs.values()), inp => {
            inp.onmidimessage = msg => {
              if (metronome && msg.data[0] == 0x90 && msg.data[2] != 0) {
                var beats = metronome.measure();
                var roundBeats = Math.round(beats);

                $('#log').append($('<div>').text(roundBeats + " (" + parseInt(metronome.toMS(beats - roundBeats)) + ")"));
              }
              if (outdevice) {
                outdevice.send(msg.data);
              }
            };
          });
          setDeviceList($('#outdevices'), Array.from(access.outputs.values()), outp => {
            outdevice = outp;
          });

          // Debug
          $('#indevices').val(1).change();
          $('#outdevices').val(0).change();

          initializeMetronome();
        });

      });
    </script>
  </head>
  <body>
    <b>In:</b><select id="indevices"></select>
    <b>Out:</b><select id="outdevices"></select>
    <br/>
    <b>Metronome:</b> Note <input id="metronomeNote" value="42">, Tempo <input id="metronomeTempo" type="text" value="100" /><button id="metronomeStart"></button>
    <pre id="log"></pre>
  </body>
</html>
