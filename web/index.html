<html>
  <head>
    <style>
    #skillMeter {
      width: 500px;
      background-color: lightgray;
    }
    #skillReading {
      width: 1%;
      height: 30px;
      background-color: lightgreen;
    }
    </style>

    <script src="jquery-3.3.1.js"></script>
    <script src="vexflow-debug.js"></script>
    <script>
      VF = Vex.Flow;

      var outdevice = null;

      var sendMIDI = function(data) {
        if (outdevice) {
          outdevice.send(data);
        }
      };

      var setDeviceList = function(sel, devs, onchange) {
        $('#devices').empty();
        $(sel).append($('<option>').attr('value', null).text("None"));
        for (var i = 0; i < devs.length; i++) {
          $(sel).append(
            $('<option>').attr('value', i).text(devs[i].name));
        }
        $(sel).change(e => {
          onchange(devs[$(sel).val()]);
        });
      };

      var Metronome = function(bpm, callback) {
        var interval = 1000*60.0/bpm;

        var stop = false;

        var start = Date.now();
        var beatno = 0;
        var step = () => {
          callback(beatno);
          beatno += 1;
          var next = start + beatno * interval;
          if (!stop) { setTimeout(step, next - Date.now()); }
        };
        step();

        return {
          stop: () => { stop = true; },
          measure: () => (Date.now() - start) / interval,
          toMS: beats => beats*interval,
        };
      };

      var metronome = null;

      var initializeMetronome = function() {
        metronome = null;
        $('#metronomeStart').text('Start');
        $('#metronomeStart').off('click').click(e => {
          var note = parseInt($('#metronomeNote').val());
          var pattern = getActivePattern();
          console.log(pattern);
          metronome = Metronome(parseInt($('#metronomeTempo').val())*pattern.spacing, beatno => {
            sendMIDI([0x91, note, pattern.velocities[beatno % pattern.velocities.length]]);
            setTimeout(() => sendMIDI([0x91, note, 0], 30));
          });
          $('#metronomeStart').text('Stop');
          $('#metronomeStart').off('click').on('click', e => {
            metronome.stop();
            initializeMetronome();
          });
        });
      };

      var SkillMeter = function(barElem, notches, penalty) {
        var score = 0;
        var update = () => $(barElem).css('width', Math.round(100.0*score/notches) + '%');
        update();
        return {
          hit: () => {
            if (score >= notches-1 && score < notches) {
              sendMIDI([0x91, 56, 0x40]); // Win bell!
              setTimeout(() => sendMIDI([0x91, 56, 0]), 30);
              score = 0;
            }
            score++;
            score = Math.min(score, notches);
            update();
          },
          miss: () => {
            score *= penalty;
            update();
          },
        };
      };

      var skillmeter = null;


      var metronomePatterns = [
        {
          notation: (cx, stave) => {
            VF.Formatter.FormatAndDraw(cx, stave, [new VF.StaveNote({ clef: "treble", keys: ["c/4"], duration: "q" })]);
          },
          spacing: 1,  // notes per beat
          velocities: [ 64 ]
        },
        {
          notation: (cx,stave) => {
            var voice = new VF.Voice({num_beats: 1, beat_value: 4});
            var notes = [ new VF.StaveNote({ clef: "treble", keys: ["c/4"], duration: "16" })
                        , new VF.StaveNote({ clef: "treble", keys: ["c/4"], duration: "16" })
                        , new VF.StaveNote({ clef: "treble", keys: ["c/4"], duration: "16" })
                        , new VF.StaveNote({ clef: "treble", keys: ["c/4"], duration: "16" })
                        ];
            voice.addTickables(notes);
            (new VF.Formatter()).joinVoices([voice]).formatToStave([voice], stave);
            var beam = new VF.Beam(notes);
            voice.draw(cx, stave);
            beam.setContext(cx).draw();
          },
          spacing: 4,
          velocities: [ 80, 44, 44, 44, ]
        }
      ];

      var activePattern = null;
      var getActivePattern = function() {
        return activePattern = metronomePatterns[$('#metronomePatterns :checked').val()];
      };

      var renderPatterns = function(container) {
        var first = true;
        for (var i = 0; i < metronomePatterns.length; i++) {
          var renderDiv = $('<div>');
          var input = $('<input>').attr('type', 'radio')
                                  .attr('name', container.attr('id'))
                                  .attr('value', i);
          if (first) {
            input.attr('checked', 'checked');
            first = false;
          }

          $(container)
            .append($('<li>')
              .append(input)
              .append(renderDiv));
            

          var renderer = new VF.Renderer(renderDiv[0], VF.Renderer.Backends.SVG);
          renderer.resize(500, 100);
          var cx = renderer.getContext();

          var stave = new VF.Stave(0, 0, 500);
          stave.setContext(cx).draw();

          metronomePatterns[i].notation(cx, stave);
        }
      };


      $(() => {
        navigator.requestMIDIAccess().then(access => {
          setDeviceList($('#indevices'), Array.from(access.inputs.values()), inp => {
            inp.onmidimessage = msg => {
              if (metronome && msg.data[0] == 0x90 && msg.data[2] != 0) {
                var beats = metronome.measure() / activePattern.spacing;
                var roundBeats = Math.round(4*beats)/4.0;

                if (Math.abs(metronome.toMS(roundBeats - beats) * activePattern.spacing) < 35) {
                  sendMIDI(msg.data);
                  if (skillmeter) { skillmeter.hit(); }
                }
                else {
                  if (skillmeter) { skillmeter.miss(); }
                }
              }
              else {
                sendMIDI(msg.data);
              }
            };
          });
          setDeviceList($('#outdevices'), Array.from(access.outputs.values()), outp => {
            outdevice = outp;
          });

          // Debug
          $('#indevices').val(1).change();
          $('#outdevices').val(0).change();

          initializeMetronome();
          renderPatterns($('#metronomePatterns'));

          skillmeter = SkillMeter($('#skillReading'), 100, 0.75);
        });

      });
    </script>
  </head>
  <body>
    <b>In:</b><select id="indevices"></select>
    <b>Out:</b><select id="outdevices"></select>
    <br/>
    <b>Metronome:</b> Note <input id="metronomeNote" value="42">, Tempo <input id="metronomeTempo" type="text" value="100" /><button id="metronomeStart"></button>

    <ul id="metronomePatterns"></ul>

    <div id="skillMeter">
      <div id="skillReading"></div>
    </div>
      
  </body>
</html>
